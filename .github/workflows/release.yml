name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    if: github.event_name == 'push' && github.ref_type == 'tag' && github.actor != 'github-actions[bot]'
    name: Create GitHub Release & Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate CHANGELOG.md
        id: changelog
        run: |
            chmod +x .github/scripts/generate_changelog.sh
            .github/scripts/generate_changelog.sh
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add CHANGELOG.md
            git commit -m "ðŸ“ Docs: Update Changelog for $GITHUB_REF_NAME" || echo "No changes to commit"
            git tag -f "$GITHUB_REF_NAME"
            git push origin HEAD:main
            git push origin "$GITHUB_REF_NAME" --force


      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
            chmod +x .github/scripts/generate_release_notes.sh
            .github/scripts/generate_release_notes.sh > release_notes.txt
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            cat release_notes.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ github.ref_name }}"
          tag_name: "${{ github.ref_name }}"
          body: "${{ steps.changelog.outputs.release_notes }}"
